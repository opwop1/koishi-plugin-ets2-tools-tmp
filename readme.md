# koishi-plugin-ets2-tools-tmp

[![npm](https://img.shields.io/npm/v/koishi-plugin-ets2-tools-tmp?style=flat-square)](https://www.npmjs.com/package/koishi-plugin-tmp-bot)

## 插件介绍

一款集欧洲卡车模拟2 (ETS2) / 美国卡车模拟 (ATS) TMP数据查询与车队活动管理于一体的多功能插件，支持自动获取活动信息、发送智能提醒，同时提供丰富的游戏数据查询功能，适配QQ等主流聊天平台。

## 功能特性

### 🎮 核心查询功能
- **玩家数据查询**: 支持TMP玩家信息、位置查询，绑定ID后操作更便捷
- **服务器与路况**: 查询欧卡/美卡服务器状态、热门地点路况（支持服务器简称）
- **游戏资源查询**: 地图DLC价格、TMP版本信息查询
- **排行与积分**: 总里程/今日里程排行榜、车队平台积分查询
- **VTC与规则**: 支持指定VTC ID查询，提供TruckersMP官方规则链接

### 🚚 车队活动管理
- **双数据源支持**: 同时从车队平台（V1.0）和TruckersMP API获取活动数据
- **智能提醒机制**: 活动开始前按配置时间发送提醒，支持多时间点设置
- **档位状态检查**: 自动检测活动档上传状态，向管理群发送提醒
- **多群组适配**: 区分管理群与主群，按需发送不同类型消息

### ⚙️ 灵活配置选项
- **数据源自定义**: 独立选择服务器、起点、终点信息来源（车队平台/ TMP API）
- **定时任务配置**: 自定义活动检查、消息发送的时间节点
- **消息模板编辑**: 支持变量替换的个性化提醒模板
- **权限与适配**: 管理员专用功能（密码重置），兼容主流聊天平台

### 🔧 开发者支持
- **多级日志记录**: 调试模式、API监控、定时任务记录等细分日志选项
- **详细调试信息**: 插件运行状态、数据统计一键查看
- **接口文档支持**: 提供TMP数据接口文档，便于二次开发

## 安装配置

### 1. 基础配置

#### API配置
- **使用HTTPS协议**: 选择是否启用HTTPS协议
- **车队平台URL**: 自行部署的车队平台地址（不含协议，仅支持V1.0版本）
- **车队平台TOKEN**: API访问认证令牌
- **VTC ID**: 您在TruckersMP的VTC ID

#### 翻译配置（可选）
- **启用百度翻译**: 开启/关闭翻译功能
- **百度翻译APP ID**: 翻译服务认证ID
- **百度翻译秘钥**: 翻译服务认证密钥
- **启用翻译缓存**: 减少重复翻译请求，提升效率

### 2. 群组配置

#### 管理群设置
- **活动检查时间**: 检查活动档位状态的时间（HH:mm格式）
- **信息发送时间**: 发送档位提醒的时间（HH:mm格式）
- **管理群组ID**: 接收管理提醒（档位状态、异常通知）的群组ID列表

#### 主群设置
- **主群群号**: 接收活动开始提醒的群组ID列表
- **活动提醒消息模板**: 支持变量替换的自定义模板
- **活动提醒时间**: 活动开始前的提醒时间点（分钟）

### 3. 数据源与消息配置

#### 数据源选择
- 服务器信息来源（车队平台API / TMP API）
- 起点信息来源（车队平台API / TMP API）
- 终点信息来源（车队平台API / TMP API）
- 活动横幅显示开关

#### 消息内容配置
- **档位已上传消息**: 活动档上传完成时的提示文案
- **档位未上传消息**: 活动档未上传时的提醒文案
- **活动提醒模板变量**: `{name}`（活动名）、`{server}`（服务器）、`{startingPoint}`（起点）、`{terminalPoint}`（终点）、`{distance}`（距离）、`{banner}`（横幅）、`{timeLeft}`（剩余时间）

### 4. 开发者选项
- **调试模式**: 启用后输出详细运行日志
- **记录API响应**: 记录API请求参数与响应详情
- **记录定时任务**: 记录定时任务执行时间、结果
- **记录活动匹配**: 记录活动数据跨源匹配过程
- **记录消息发送**: 记录消息发送状态、接收群组

## 指令说明

| 指令名称         | 指令介绍                                                                                                                                        | 使用示例               |
|------------------|---------------------------------------------------------------------------------------------------------------------------------------------|------------------------|
| 绑定 <tmpId>     | 绑定TMP ID，绑定后使用其他指令可省略ID输入                                                                                                          | 绑定 123               |
| 查询 <tmpId>     | 查询TMP玩家基础信息                                                                                                                               | 查询 123               |
| 定位 <tmpId>     | 查询玩家当前位置信息                                                                                                                             | 定位 123               |
| 路况 <serverName> | 查询服务器热门地点路况，支持简称：s1(Simulation 1)、s2(Simulation 2)、p(ProMods)、a(Arcade)                                                      | 路况 s1                |
| 美卡服务器       | 查询美卡（ATS）服务器状态列表                                                                                                                     | 美卡服务器             |
| 欧卡服务器       | 查询欧卡（ETS2）服务器状态列表                                                                                                                    | 欧卡服务器             |
| tmp版本          | 查询TMP当前版本信息                                                                                                                               | tmp版本                |
| 地图dlc价格      | 查看地图DLC价格列表                                                                                                                               | 地图dlc价格            |
| 里程排行榜       | 总里程排行榜（数据从2025年8月23日20:00开始统计，绑定ID后可查个人排名）                                                                                   | 里程排行榜             |
| 今日里程排行榜   | 今日里程排行榜（每日0点重置数据，绑定ID后可查个人排名）                                                                                              | 今日里程排行榜         |
| vtc查询 <vtcid>  | 查询指定VTC ID的详细信息                                                                                                                          | vtc查询 456            |
| 重置密码 [teamId]| 重置车队平台（V1.0）密码，管理员可指定teamId，普通用户重置自身密码                                                                                        | 重置密码 789           |
| 查询积分 [QQ号]  | 查询车队平台（V1.0）积分，可查询自身或指定QQ号积分                                                                                                    | 查询积分 123456        |
| 规则查询         | 获取TruckersMP官方规则链接                                                                                                                        | 规则查询               |
| 活动查询         | 手动检查今日活动数据，返回活动数量统计                                                                                                              | 活动查询               |
| 活动DEBUG        | 查看插件运行状态、数据统计等调试信息                                                                                                               | 活动DEBUG              |
| 重置数据         | 手动重置今日活动数据与提醒记录                                                                                                                     | 重置数据               |

## 使用方法

### 自动功能
- 每日凌晨2点自动重置活动数据
- 按配置时间自动检查活动数据与档位状态
- 向管理群发送档位上传状态提醒
- 活动开始前按配置时间点向主群发送提醒

### 注意事项
- 车队平台仅支持V1.0版本，V2.0版本适配将在后续更新
- 路况查询仅支持指定服务器简称，需按规则输入（s1/s2/p/a）
- 管理员专用功能（如批量重置密码）需提前配置管理员权限

## 技术支持

### 接口文档
TMP数据接口文档：https://apifox.com/apidoc/shared/38508a88-5ff4-4b29-b724-41f9d3d3336a

### 问题排查
1. 启用调试模式查看详细日志，定位问题原因
2. 检查API配置（URL、TOKEN、VTC ID）是否正确
3. 确认群组ID格式正确，机器人拥有发送消息权限
4. 定时任务未执行可检查服务器时间与配置时间是否匹配

## 鸣谢
特别感谢 [79887143](https://github.com/79887143) 提供的API接口与开发思路，基于其开源项目 [koishi-plugin-tmp-bot](https://github.com/79887143/koishi-plugin-tmp-bot?tab=readme-ov-file#koishi-plugin-tmp-bot) 扩展开发。

## 版本信息
- 支持平台: Koishi
- 依赖: HTTP请求、定时任务、数据库
- 适配器: 支持主流聊天平台（除邮件适配器外）
- 车队平台支持: V1.0（V2.0适配待更新）